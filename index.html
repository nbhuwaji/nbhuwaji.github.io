<script>
    const TOTAL_PAGES = 28;
    const INITIAL_PAGES = 4; // Load first 4 pages immediately

    window.addEventListener('load', () => {
        console.log('Starting portfolio load...');
        setTimeout(initPortfolio, 100);
    });

    function initPortfolio() {
        const flipbook = document.getElementById('flipbook');
        const progressText = document.getElementById('progress-text');

        progressText.textContent = 'Loading first pages...';

        // 1️⃣ Load first spread/pages immediately
        for (let i = 1; i <= INITIAL_PAGES; i++) {
            appendPage(flipbook, i);
        }

        // 2️⃣ Initialize flipbook right away
        setTimeout(() => {
            $('#flipbook').turn({
                width: 1200,
                height: 700,
                autoCenter: true,
                display: 'double',
                acceleration: true,
                gradients: true,
                elevation: 50,
                duration: 1200
            }).bind('turned', function(e, page) {
                updatePage(page);
            });

            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('flipbook-wrapper').style.display = 'flex';
            updatePage(1);

            // 3️⃣ Load remaining pages silently in background
            loadRemainingPages(flipbook, INITIAL_PAGES + 1, TOTAL_PAGES);

        }, 300); // slight delay to show spinner
    }

    function appendPage(container, i) {
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        const img = document.createElement('img');
        const pageNum = String(i).padStart(2, '0');
        img.src = `pages/pages_${pageNum}.jpg`;
        img.alt = `Page ${i}`;
        img.onerror = () => { img.style.display = 'none'; console.error(`Failed to load page ${i}`); };
        pageDiv.appendChild(img);
        container.appendChild(pageDiv);
    }

    function loadRemainingPages(container, start, end) {
        const progressText = document.getElementById('progress-text');
        let loaded = start - 1;

        function loadNextPage(i) {
            if (i > end) {
                progressText.textContent = 'All pages loaded!';
                return;
            }

            const img = new Image();
            const pageNum = String(i).padStart(2, '0');
            img.src = `pages/pages_${pageNum}.jpg`;
            img.onload = () => {
                appendPage(container, i);
                loaded++;
                progressText.textContent = `Loaded ${loaded}/${TOTAL_PAGES} pages`;
                setTimeout(() => loadNextPage(i + 1), 50); // small delay to avoid blocking
            };
            img.onerror = () => {
                console.error(`Failed to load page ${i}`);
                setTimeout(() => loadNextPage(i + 1), 50);
            };
        }

        loadNextPage(start);
    }

    function updatePage(page) {
        const info = document.getElementById('page-info');
        const prev = document.getElementById('prev-btn');
        const next = document.getElementById('next-btn');

        if (page === 1) {
            info.textContent = `Page ${page}`;
        } else if (page + 1 > TOTAL_PAGES) {
            info.textContent = `Page ${page}`;
        } else {
            info.textContent = `Pages ${page}-${page + 1}`;
        }

        prev.disabled = (page === 1);
        next.disabled = (page >= TOTAL_PAGES);
    }

    document.getElementById('prev-btn').onclick = () => $('#flipbook').turn('previous');
    document.getElementById('next-btn').onclick = () => $('#flipbook').turn('next');

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') $('#flipbook').turn('previous');
        if (e.key === 'ArrowRight') $('#flipbook').turn('next');
    });

    document.getElementById('fullscreen-btn').onclick = function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            this.textContent = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            this.textContent = 'Fullscreen';
        }
    };

    document.addEventListener('fullscreenchange', () => {
        const btn = document.getElementById('fullscreen-btn');
        btn.textContent = document.fullscreenElement ? 'Exit Fullscreen' : 'Fullscreen';
    });
</script>
